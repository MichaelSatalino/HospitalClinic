{% extends "base.html" %} {% block content %}
<h2>Prescription ADD</h2>
<form action="" method="post">
    {{ form.hidden_tag() }}
    <p>
        {{ form.pharmacy_name.label }} <br> {{ form.pharmacy_name() }}
    </p>
    <p>
        {{form.pharmacy_address.label}} <br> {{form.pharmacy_address()}}
    </p>
    <p>
        {{ form.medication_name.label }} <br> {{ form.medication_name() }}
    </p>
    <p id="error" style="color: red; display:none;">Invalid Medication Name</p>
    <p id="doseContainer" style="display: none;">
        {{ form.dosage.label}} <br> {{form.dosage()}}
    </p>
    <p>
        {{ form.refills.label }} <br> {{ form.refills() }}
    </p>
    <p>{{form.submit()}}</p>
    {{form.medication_id}}
    {% if form.errors %}
{{ form.errors }}
{% endif %}
</form>
<script>
    let pharm_name = document.getElementById('pharmacy_name');
    let pharm_addr = document.getElementById('pharmacy_address');

    let doseContainer= document.getElementById('doseContainer');
    let dosage_select = document.getElementById('dosage');
    let err_msg = document.getElementById('error');
    let med_id = document.getElementById("medication_id");

    pharm_name.onchange = function() {
        name = pharm_name.value;
        console.log(name);
        fetch("/pharmacy/"+name).then(function(response) {
            response.json().then(function(data) {
                let optionHTML =""
                for(let pharm of data.pharms) {
                    optionHTML += '<option value="'+pharm.id+'">'+pharm.address+'</option>';

                }
                pharm_addr.innerHTML=optionHTML;
            })
        })
    }

    
    $( function() { 
    var availableTags = [ 
        {% for med in med_name %} 
            "{{med}}", 
        {% endfor %} 
    ]; 
    $( "#medication_name" ).autocomplete({ 
      source: availableTags,
      select: function( event, ui) {
        let name = ui.item.value;
        console.log(name);
        fetch("/dosage/"+name).then(function(response) {
            response.json().then(function(data) {
                console.log(data.doses.length);
                if(data.doses.length==0) {
                    err_msg.style.display="block";
                    med_id.value="";
                    doseContainer.style.display="none";
                }
                else {
                    err_msg.style.display="none";
                    med_id.value=data.doses[0].id;
                    doseContainer.style.display="block";
                }
                
                let optionHTML ="";
                    for (let d of data.doses) {
                        optionHTML += '<option value="'+d.dose +'">'+d.dose+'</option>';
                    }
                dosage_select.innerHTML=optionHTML;
            })
        })
      } 
    }); 
  } );
  $("#medication_name") 

</script>
{% endblock %}